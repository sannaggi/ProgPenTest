<?php
require "../include/include.php";

if($_SERVER['REQUEST_METHOD'] == 'POST') {
    $username = $_POST['username'];
    $password = $_POST['password'];
    $token = $_POST['_token'];
    
    if (get_csrf() != $token) {
        set_error('Unauthorized');
        redirect('../login.php');
    }

    $hash_password = md5($password);

    $sql = "SELECT * FROM user WHERE username = '$username' AND password = '$hash_password'";
    $result = $conn->query($sql);

    if($result->num_rows > 0) {
        session_regenerate_id();

        $row = $result->fetch_assoc();
        $_SESSION['username'] = $username;
        redirect('../index.php');
    } else {
        $_SESSION['error'] = 'Wrong username or password';
        redirect('../login.php');
    }
}